<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#facc15">
    <meta name="description" content="SinoLab - IoT Device Control">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SinoLab">

    <title>SinoLab - Dashboard</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="sidebar-logo-icon">üî¨</span>
                    <span class="sidebar-logo-text">SinoLab</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <button class="sidebar-nav-item active" data-page="status">
                    <span class="sidebar-nav-icon">üìä</span>
                    <span class="sidebar-nav-text">Status</span>
                </button>
                <button class="sidebar-nav-item" data-page="dispense">
                    <span class="sidebar-nav-icon">üíß</span>
                    <span class="sidebar-nav-text">Dispense</span>
                </button>
                <button class="sidebar-nav-item" data-page="system">
                    <span class="sidebar-nav-icon">‚ÑπÔ∏è</span>
                    <span class="sidebar-nav-text">System Info</span>
                </button>
            </nav>

            <div class="sidebar-footer">
                <div class="sidebar-device-info">
                    <span id="sidebarDeviceId" class="sidebar-device-id">--</span>
                    <span id="sidebarConnectionStatus" class="sidebar-connection connecting">Connecting...</span>
                </div>
                <div class="sidebar-actions">
                    <button id="changeDeviceBtn" class="sidebar-action-btn" title="Change Device">
                        üì±
                    </button>
                    <button id="logoutBtn" class="sidebar-action-btn" title="Logout">
                        üö™
                    </button>
                </div>
            </div>
        </aside>

        <!-- Mobile Header (visible on small screens) -->
        <header class="mobile-header">
            <button id="menuToggle" class="mobile-menu-btn">‚ò∞</button>
            <div class="mobile-logo">
                <span>üî¨</span>
                <span>SinoLab</span>
            </div>
            <div id="mobileConnectionStatus" class="mobile-connection connecting"></div>
        </header>

        <!-- Mobile Sidebar Overlay -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Status Page -->
            <div id="statusPage" class="dashboard-page active">
                <div class="page-header">
                    <h1 class="page-title">Pump Status</h1>
                    <span id="lastUpdated" class="page-subtitle">Last updated: --</span>
                </div>

                <div class="page-content">
                    <!-- Main Status Card -->
                    <div class="status-card">
                        <div class="status-main">
                            <div class="status-indicator" id="pumpStatusIndicator">
                                <div class="status-indicator-icon stopped">‚èπÔ∏è</div>
                                <div class="status-indicator-text">Stopped</div>
                            </div>
                            <div class="status-rpm">
                                <div class="status-rpm-value" id="currentRPM">0</div>
                                <div class="status-rpm-label">RPM</div>
                            </div>
                        </div>

                        <div class="status-details">
                            <div class="status-detail-item">
                                <span class="status-detail-label">Direction</span>
                                <span class="status-detail-value" id="direction">CW</span>
                            </div>
                            <div class="status-detail-item">
                                <span class="status-detail-label">Flow Rate</span>
                                <span class="status-detail-value" id="flowRate">N/A</span>
                            </div>
                            <div class="status-detail-item">
                                <span class="status-detail-label">Control Mode</span>
                                <span class="status-detail-value" id="controlMode">LOCAL</span>
                            </div>
                        </div>
                    </div>

                    <!-- Dispense Statistics -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üíß</div>
                            <div class="stat-content">
                                <div class="stat-value" id="sessionDispensed">0.0 mL</div>
                                <div class="stat-label">Session Dispensed</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-content">
                                <div class="stat-value" id="totalDispensed">0.000 L</div>
                                <div class="stat-label">Total Dispensed</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <h3 class="section-title">Quick Actions</h3>
                        <div class="quick-action-buttons">
                            <button id="quickStopBtn" class="btn btn-danger btn-lg">
                                üõë Emergency Stop
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dispense Page -->
            <div id="dispensePage" class="dashboard-page">
                <div class="page-header">
                    <h1 class="page-title">Dispense Mode</h1>
                </div>

                <div class="page-content">
                    <!-- Calibration Warning -->
                    <div id="calibrationWarning" class="warning-banner hidden">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <span class="warning-text">Calibration required for Volume-Based mode. Please calibrate from device.</span>
                    </div>

                    <!-- Mode Tabs -->
                    <div class="mode-tabs">
                        <button id="rpmTab" class="mode-tab active">RPM-Based</button>
                        <button id="volumeTab" class="mode-tab">Volume-Based</button>
                    </div>

                    <!-- RPM-Based Panel -->
                    <div id="rpmPanel" class="dispense-panel active">
                        <div class="control-panel">
                            <!-- RPM Input -->
                            <div class="control-group">
                                <label class="control-label">RPM</label>
                                <div class="control-input-wrapper">
                                    <input
                                        type="number"
                                        id="rpmInput"
                                        class="control-input"
                                        min="0"
                                        max="400"
                                        value="100"
                                        placeholder="0-400"
                                    >
                                    <span class="control-input-hint">0 - 400</span>
                                </div>
                                <input
                                    type="range"
                                    id="rpmSlider"
                                    class="control-slider"
                                    min="0"
                                    max="400"
                                    step="10"
                                    value="100"
                                >
                            </div>

                            <!-- ON Time Input -->
                            <div class="control-group">
                                <label class="control-label">ON Time (seconds)</label>
                                <div class="control-input-wrapper">
                                    <input
                                        type="number"
                                        id="onTimeInput"
                                        class="control-input"
                                        min="0"
                                        value="0"
                                        placeholder="0 = continuous"
                                    >
                                    <span class="control-input-hint">0 = continuous run</span>
                                </div>
                            </div>

                            <!-- OFF Time Input -->
                            <div class="control-group">
                                <label class="control-label">OFF Time (seconds)</label>
                                <div class="control-input-wrapper">
                                    <input
                                        type="number"
                                        id="offTimeInput"
                                        class="control-input"
                                        min="0"
                                        value="0"
                                        placeholder="0 = no pause"
                                    >
                                    <span class="control-input-hint">Pause between cycles</span>
                                </div>
                            </div>

                            <!-- Direction Toggle -->
                            <div class="control-group">
                                <label class="control-label">Direction</label>
                                <div class="direction-toggle">
                                    <button type="button" id="directionCW" class="direction-btn active">
                                        ‚Üª CW
                                    </button>
                                    <button type="button" id="directionCCW" class="direction-btn">
                                        ‚Ü∫ CCW
                                    </button>
                                </div>
                            </div>

                            <!-- Run Button -->
                            <div class="control-actions">
                                <button id="runBtn" class="btn btn-primary btn-lg btn-full">
                                    ‚ñ∂Ô∏è Run
                                </button>
                                <button id="stopBtn" class="btn btn-outline btn-lg btn-full" style="margin-top: 0.75rem;">
                                    ‚èπÔ∏è Stop
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Volume-Based Panel -->
                    <div id="volumePanel" class="dispense-panel">
                        <div class="control-panel" style="position: relative;">
                            <!-- Disabled Overlay -->
                            <div id="volumeOverlay" class="volume-overlay hidden">
                                <div class="volume-overlay-content">
                                    <span class="volume-overlay-icon">‚ö†Ô∏è</span>
                                    <span class="volume-overlay-text">Calibration Required</span>
                                </div>
                            </div>

                            <!-- Volume Input -->
                            <div class="control-group">
                                <label class="control-label">Target Volume (mL)</label>
                                <div class="control-input-wrapper">
                                    <input
                                        type="number"
                                        id="volumeInput"
                                        class="control-input"
                                        min="0.1"
                                        max="9999"
                                        step="0.1"
                                        placeholder="Enter volume"
                                    >
                                </div>
                            </div>

                            <!-- Speed (RPM) for Volume Mode -->
                            <div class="control-group">
                                <label class="control-label">Speed (RPM)</label>
                                <div class="control-input-wrapper">
                                    <input
                                        type="number"
                                        id="volumeRpmInput"
                                        class="control-input"
                                        min="10"
                                        max="400"
                                        value="100"
                                    >
                                </div>
                                <input
                                    type="range"
                                    id="volumeRpmSlider"
                                    class="control-slider"
                                    min="10"
                                    max="400"
                                    step="10"
                                    value="100"
                                >
                            </div>

                            <!-- Direction for Volume Mode -->
                            <div class="control-group">
                                <label class="control-label">Direction</label>
                                <div class="direction-toggle">
                                    <button type="button" id="volumeDirectionCW" class="direction-btn active">
                                        ‚Üª CW
                                    </button>
                                    <button type="button" id="volumeDirectionCCW" class="direction-btn">
                                        ‚Ü∫ CCW
                                    </button>
                                </div>
                            </div>

                            <!-- Estimated Time -->
                            <div class="estimation-box" id="estimatedTime">
                                <div class="estimation-icon">‚è±Ô∏è</div>
                                <div class="estimation-content">
                                    <div class="estimation-value">--</div>
                                    <div class="estimation-label">Estimated Time</div>
                                </div>
                            </div>

                            <!-- Dispense Button -->
                            <div class="control-actions">
                                <button id="dispenseBtn" class="btn btn-primary btn-lg btn-full">
                                    üíß Dispense
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Info Page -->
            <div id="systemPage" class="dashboard-page">
                <div class="page-header">
                    <h1 class="page-title">System Information</h1>
                </div>

                <div class="page-content">
                    <!-- Device Information -->
                    <div class="info-section">
                        <h3 class="info-section-title">üì± Device Information</h3>
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">Device Name</span>
                                <span class="info-value" id="infoDeviceName">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Device ID</span>
                                <span class="info-value mono" id="infoDeviceId">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Firmware Version</span>
                                <span class="info-value" id="infoFirmware">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">IP Address</span>
                                <span class="info-value mono" id="infoIP">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">MAC Address</span>
                                <span class="info-value mono" id="infoMAC">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Last Seen</span>
                                <span class="info-value" id="infoLastSeen">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Total Runtime</span>
                                <span class="info-value" id="infoRuntime">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Calibration Information -->
                    <div class="info-section">
                        <h3 class="info-section-title">‚öôÔ∏è Calibration Settings</h3>
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">Tube Size</span>
                                <span class="info-value" id="settingsTube">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Calibration Value</span>
                                <span class="info-value" id="settingsMlPerRev">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Calibration Type</span>
                                <span class="info-value" id="settingsCalibrationType">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Last Calibrated</span>
                                <span class="info-value" id="settingsLastCalibrated">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Anti-Drip</span>
                                <span class="info-value" id="settingsAntiDrip">--</span>
                            </div>
                        </div>
                        <p class="info-note">
                            ‚ÑπÔ∏è Calibration settings can only be changed from the device's physical controls.
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Modules -->
    <script src="js/firebase-config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/device.js"></script>
    <script src="js/dashboard.js"></script>

    <!-- Page Initialization -->
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then((reg) => console.log('Service Worker registered:', reg.scope))
                .catch((err) => console.log('Service Worker registration failed:', err));
        }

        // Sidebar Navigation
        document.querySelectorAll('.sidebar-nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;

                // Update active nav item
                document.querySelectorAll('.sidebar-nav-item').forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');

                // Show selected page
                document.querySelectorAll('.dashboard-page').forEach(p => p.classList.remove('active'));
                document.getElementById(page + 'Page').classList.add('active');

                // Close mobile sidebar
                document.querySelector('.sidebar').classList.remove('open');
                document.getElementById('sidebarOverlay').classList.remove('active');
            });
        });

        // Mobile menu toggle
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        });

        // Close sidebar on overlay click
        document.getElementById('sidebarOverlay').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        });

        // Dispense mode tabs
        document.getElementById('rpmTab').addEventListener('click', () => {
            document.getElementById('rpmTab').classList.add('active');
            document.getElementById('volumeTab').classList.remove('active');
            document.getElementById('rpmPanel').classList.add('active');
            document.getElementById('volumePanel').classList.remove('active');
        });

        document.getElementById('volumeTab').addEventListener('click', () => {
            document.getElementById('volumeTab').classList.add('active');
            document.getElementById('rpmTab').classList.remove('active');
            document.getElementById('volumePanel').classList.add('active');
            document.getElementById('rpmPanel').classList.remove('active');
        });

        // RPM slider sync
        document.getElementById('rpmSlider').addEventListener('input', (e) => {
            document.getElementById('rpmInput').value = e.target.value;
        });
        document.getElementById('rpmInput').addEventListener('input', (e) => {
            const val = Math.min(400, Math.max(0, parseInt(e.target.value) || 0));
            document.getElementById('rpmSlider').value = val;
        });

        // Volume RPM slider sync
        document.getElementById('volumeRpmSlider').addEventListener('input', (e) => {
            document.getElementById('volumeRpmInput').value = e.target.value;
        });
        document.getElementById('volumeRpmInput').addEventListener('input', (e) => {
            const val = Math.min(400, Math.max(10, parseInt(e.target.value) || 10));
            document.getElementById('volumeRpmSlider').value = val;
        });

        // Direction toggles
        ['', 'volume'].forEach(prefix => {
            const cwBtn = document.getElementById(prefix ? prefix + 'DirectionCW' : 'directionCW');
            const ccwBtn = document.getElementById(prefix ? prefix + 'DirectionCCW' : 'directionCCW');

            cwBtn.addEventListener('click', () => {
                cwBtn.classList.add('active');
                ccwBtn.classList.remove('active');
            });
            ccwBtn.addEventListener('click', () => {
                ccwBtn.classList.add('active');
                cwBtn.classList.remove('active');
            });
        });

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            Dashboard.initDashboard();
        });
    </script>
</body>
</html>
