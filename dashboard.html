<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#facc15">
    <meta name="description" content="SinoLab - IoT Device Control">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SinoLab">

    <title>SinoLab - Dashboard</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="sidebar-logo-icon">üî¨</span>
                    <span class="sidebar-logo-text">SinoLab</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <button class="sidebar-nav-item active" data-page="status">
                    <span class="sidebar-nav-icon">üìä</span>
                    <span class="sidebar-nav-text">Status</span>
                </button>
                <button class="sidebar-nav-item" data-page="dispense">
                    <span class="sidebar-nav-icon">üíß</span>
                    <span class="sidebar-nav-text">Dispense</span>
                </button>
                <button class="sidebar-nav-item" data-page="system">
                    <span class="sidebar-nav-icon">‚ÑπÔ∏è</span>
                    <span class="sidebar-nav-text">System Info</span>
                </button>
            </nav>

            <div class="sidebar-footer">
                <div class="sidebar-device-info">
                    <span id="sidebarDeviceId" class="sidebar-device-id">--</span>
                    <span id="sidebarConnectionStatus" class="sidebar-connection connecting">Connecting...</span>
                </div>
                <div class="sidebar-actions">
                    <button id="changeDeviceBtn" class="sidebar-action-btn" title="Change Device">
                        üì±
                    </button>
                    <button id="logoutBtn" class="sidebar-action-btn" title="Logout">
                        üö™
                    </button>
                </div>
            </div>
        </aside>

        <!-- Mobile Header -->
        <header class="mobile-header">
            <button id="menuToggle" class="mobile-menu-btn">‚ò∞</button>
            <div class="mobile-logo">
                <span>üî¨</span>
                <span>SinoLab</span>
            </div>
            <div id="mobileConnectionStatus" class="mobile-connection connecting"></div>
        </header>

        <!-- Mobile Sidebar Overlay -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <!-- Running Lock Overlay -->
        <div id="runningLockOverlay" class="running-lock-overlay hidden">
            <div class="running-lock-content">
                <div class="running-lock-icon">‚ö†Ô∏è</div>
                <div class="running-lock-text">ŸæŸÖŸæ ÿØÿ± ÿ≠ÿßŸÑ ÿßÿ¨ÿ±ÿß ÿßÿ≥ÿ™</div>
                <div class="running-lock-subtext">ÿ®ÿ±ÿß€å ÿ±ŸÅÿ™ŸÜ ÿ®Ÿá ÿµŸÅÿ≠ÿßÿ™ ÿØ€å⁄Øÿ± ÿßÿ®ÿ™ÿØÿß ŸæŸÖŸæ ÿ±ÿß ŸÖÿ™ŸàŸÇŸÅ ⁄©ŸÜ€åÿØ</div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Status Page (Pump Control) -->
            <div id="statusPage" class="dashboard-page active">
                <div class="page-header">
                    <h1 class="page-title">Pump Control</h1>
                    <span id="lastUpdated" class="page-subtitle">Last updated: --</span>
                </div>

                <div class="page-content">
                    <!-- Calibration Warning -->
                    <div id="calibrationWarning" class="warning-banner hidden">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <div class="warning-content">
                            <span class="warning-title">Calibration Required</span>
                            <span class="warning-text">Please calibrate and set Tube ID first to enable Flow control.</span>
                        </div>
                    </div>

                    <!-- Pump Control Panel -->
                    <div class="pump-control-panel">
                        <div class="control-grid">
                            <!-- RPM Control -->
                            <div class="control-section rpm-section">
                                <div class="control-section-title">RPM</div>
                                <div class="rpm-control">
                                    <button type="button" id="rpmMinus" class="rpm-btn rpm-minus" disabled>‚àí</button>
                                    <input type="number" id="rpmInput" class="rpm-input" value="100" min="0" max="400" disabled>
                                    <button type="button" id="rpmPlus" class="rpm-btn rpm-plus" disabled>+</button>
                                </div>
                                <input type="range" id="rpmSlider" class="rpm-slider" min="0" max="400" step="10" value="100" disabled>
                                <div class="rpm-range-labels">
                                    <span>0</span>
                                    <span>400</span>
                                </div>
                            </div>

                            <!-- Flow Display -->
                            <div class="control-section flow-section">
                                <div class="control-section-title">Flow (ml/min)</div>
                                <div class="flow-display">
                                    <span id="flowValue" class="flow-value">--</span>
                                </div>
                            </div>

                            <!-- Direction Control -->
                            <div class="control-section direction-section">
                                <div class="control-section-title">Direction</div>
                                <div class="direction-control">
                                    <button type="button" id="directionBtn" class="direction-btn-large" disabled>
                                        <span class="direction-icon">‚Üª</span>
                                    </button>
                                    <span id="directionText" class="direction-text-label">ÿ≥ÿßÿπÿ™⁄Øÿ±ÿØ</span>
                                </div>
                            </div>

                            <!-- Total Flow Display -->
                            <div class="control-section total-section">
                                <div class="control-section-title">Total Flow</div>
                                <div class="total-flow-display">
                                    <span id="totalFlowValue" class="total-flow-value">0.00</span>
                                    <span class="total-flow-unit">mL</span>
                                </div>
                            </div>
                        </div>

                        <!-- Start/Stop Button -->
                        <div class="start-stop-container">
                            <button type="button" id="startStopBtn" class="start-stop-btn start">
                                <span class="start-stop-icon">‚ñ∂</span>
                                <span class="start-stop-text">Start</span>
                            </button>
                        </div>
                    </div>

                    <!-- Status Info -->
                    <div class="status-info-panel">
                        <div class="status-info-row">
                            <span class="status-info-label">Status</span>
                            <span id="pumpStatus" class="status-info-value status-stopped">Stopped</span>
                        </div>
                        <div class="status-info-row">
                            <span class="status-info-label">Current RPM</span>
                            <span id="currentRPM" class="status-info-value">0</span>
                        </div>
                        <div class="status-info-row">
                            <span class="status-info-label">Control Mode</span>
                            <span id="controlMode" class="status-info-value">LOCAL</span>
                        </div>
                        <div class="status-info-row">
                            <span class="status-info-label">Session Dispensed</span>
                            <span id="sessionDispensed" class="status-info-value">0.0 mL</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dispense Page (Volume-Based) -->
            <div id="dispensePage" class="dashboard-page">
                <div class="page-header">
                    <h1 class="page-title">Volume Dispense</h1>
                </div>

                <div class="page-content">
                    <!-- Calibration Required Warning -->
                    <div id="dispenseCalibrationWarning" class="warning-banner">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <div class="warning-content">
                            <span class="warning-title">Calibration Required</span>
                            <span class="warning-text">Volume-based dispense requires calibration. Please calibrate from device first.</span>
                        </div>
                    </div>

                    <!-- Volume Dispense Panel -->
                    <div id="volumeDispensePanel" class="control-panel hidden">
                        <!-- Volume Input -->
                        <div class="control-group">
                            <label class="control-label">Target Volume (mL)</label>
                            <div class="control-input-wrapper">
                                <input type="number" id="volumeInput" class="control-input" min="0.1" max="9999" step="0.1" placeholder="Enter volume">
                            </div>
                        </div>

                        <!-- Speed (RPM) -->
                        <div class="control-group">
                            <label class="control-label">Speed (RPM)</label>
                            <div class="control-input-wrapper">
                                <input type="number" id="volumeRpmInput" class="control-input" min="10" max="400" value="100">
                            </div>
                            <input type="range" id="volumeRpmSlider" class="control-slider" min="10" max="400" step="10" value="100">
                        </div>

                        <!-- Direction -->
                        <div class="control-group">
                            <label class="control-label">Direction</label>
                            <div class="direction-toggle">
                                <button type="button" id="volumeDirCW" class="direction-toggle-btn active">
                                    <span>‚Üª</span>
                                    <span>ÿ≥ÿßÿπÿ™⁄Øÿ±ÿØ</span>
                                </button>
                                <button type="button" id="volumeDirCCW" class="direction-toggle-btn">
                                    <span>‚Ü∫</span>
                                    <span>ŸæÿßÿØÿ≥ÿßÿπÿ™⁄Øÿ±ÿØ</span>
                                </button>
                            </div>
                        </div>

                        <!-- Estimated Time -->
                        <div class="estimation-box" id="estimatedTime">
                            <div class="estimation-icon">‚è±Ô∏è</div>
                            <div class="estimation-content">
                                <div class="estimation-value">--</div>
                                <div class="estimation-label">Estimated Time</div>
                            </div>
                        </div>

                        <!-- Dispense Button -->
                        <div class="control-actions">
                            <button id="dispenseBtn" class="btn btn-primary btn-lg btn-full">
                                üíß Dispense
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Info Page -->
            <div id="systemPage" class="dashboard-page">
                <div class="page-header">
                    <h1 class="page-title">System Information</h1>
                </div>

                <div class="page-content">
                    <!-- Device Information -->
                    <div class="info-section">
                        <h3 class="info-section-title">üì± Device Information</h3>
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">Device Name</span>
                                <span class="info-value" id="infoDeviceName">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Device ID</span>
                                <span class="info-value mono" id="infoDeviceId">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Firmware Version</span>
                                <span class="info-value" id="infoFirmware">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">IP Address</span>
                                <span class="info-value mono" id="infoIP">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">MAC Address</span>
                                <span class="info-value mono" id="infoMAC">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Last Seen</span>
                                <span class="info-value" id="infoLastSeen">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Total Runtime</span>
                                <span class="info-value" id="infoRuntime">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Calibration Information -->
                    <div class="info-section">
                        <h3 class="info-section-title">‚öôÔ∏è Calibration Settings</h3>
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">Tube Size</span>
                                <span class="info-value" id="settingsTube">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Calibration Value</span>
                                <span class="info-value" id="settingsMlPerRev">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Calibration Type</span>
                                <span class="info-value" id="settingsCalibrationType">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Last Calibrated</span>
                                <span class="info-value" id="settingsLastCalibrated">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Anti-Drip</span>
                                <span class="info-value" id="settingsAntiDrip">--</span>
                            </div>
                        </div>
                        <p class="info-note">
                            ‚ÑπÔ∏è Calibration settings can only be changed from the device's physical controls.
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Modules -->
    <script src="js/firebase-config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/device.js"></script>
    <script src="js/dashboard.js"></script>

    <!-- Page Initialization -->
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then((reg) => console.log('Service Worker registered:', reg.scope))
                .catch((err) => console.log('Service Worker registration failed:', err));
        }

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            Dashboard.initDashboard();
        });
    </script>
</body>
</html>
